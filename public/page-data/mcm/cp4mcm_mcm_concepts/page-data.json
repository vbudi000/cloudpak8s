{"componentChunkName":"component---src-pages-mcm-cp-4-mcm-mcm-concepts-index-mdx","path":"/mcm/cp4mcm_mcm_concepts/","result":{"pageContext":{"frontmatter":{"title":"MCM - Concepts","weight":310},"relativePagePath":"/mcm/cp4mcm_mcm_concepts/index.mdx","titleType":"page","MdxNode":{"id":"fbffecd1-eab2-5a87-926a-10bc5c5bc66d","children":[],"parent":"229cb152-be07-526a-8255-bc142211e645","internal":{"content":"---\ntitle: MCM - Concepts\nweight: 310\n---\n- \n{:toc}\n\n\n## Overview\n\nMCM Manages applications by defining them as custom resource definitions in Kubernetes. By defining these resources we can install, delete and update resources on the managed MCM clusters. When these MCM resources are created the changes are applied on the target MCM cluster via the MCM Klusterlet.\n\nIn the next sections we will explore the different resources MCM provides.\n\n## Channels\n\nThe channel resource defines the location of an resource to be deployed. These resources can be a Helm repository, Kubernetes namespace, Object store or Git repository.\n\nThe sample below describes a Channel the points to a HelmRepo.\n\n```\nkubectl create -f - <<EOF\napiVersion: v1\nkind: Namespace\nmetadata: \n  name: google-deployables\n---\napiVersion: app.ibm.com/v1alpha1\nkind: Channel\nmetadata:\n  name: google-incubator-repo\n  namespace: google-deployables\nspec:\n    type: HelmRepo\n    pathname: http://storage.googleapis.com/kubernetes-charts-incubator\nEOF\n```\n\nOnce the channel definition above has been applied you can get your channel.\n\n```\noc get channels -n google-deployables\nNAME                    TYPE       PATHNAME                                                    AGE\ngoogle-incubator-repo   HelmRepo   http://storage.googleapis.com/kubernetes-charts-incubator   3m41s\n```\n\nWhen the channel is created it will query the target HelmRepo and create MCM `deployables` for each of the Helm charts in the repo.\n\n```\noc get deployables -n google-deployables\nNAME                                                               TEMPLATE-KIND   TEMPLATE-APIVERSION    AGE     STATUS\ngoogle-incubator-repo-artifactory-5.2.1                            HelmRelease     app.ibm.com/v1alpha1   5m39s\ngoogle-incubator-repo-aws-alb-ingress-controller-0.1.12            HelmRelease     app.ibm.com/v1alpha1   5m38s\ngoogle-incubator-repo-azuremonitor-containers-2.5.0                HelmRelease     app.ibm.com/v1alpha1   5m43s\n...\n...\n...\napp.ibm.com/v1alpha1   5m43s\ngoogle-incubator-repo-tensorflow-inception-0.4.1                   HelmRelease     app.ibm.com/v1alpha1   5m45s\ngoogle-incubator-repo-vault-0.23.4                                 HelmRelease     app.ibm.com/v1alpha1   5m50s\ngoogle-incubator-repo-vaultingkube-0.1.2                           HelmRelease     app.ibm.com/v1alpha1   5m50s\ngoogle-incubator-repo-webpagetest-agent-0.2.0                      HelmRelease     app.ibm.com/v1alpha1   5m50s\ngoogle-incubator-repo-webpagetest-server-0.2.1                     HelmRelease     app.ibm.com/v1alpha1   5m38s\ngoogle-incubator-repo-xray-0.3.2                                   HelmRelease     app.ibm.com/v1alpha1   5m49s\n```\n\nYou can see that all the Helm charts are now available as `deployables` and are available to be deployed using MCM. In this section a HelmRepo has been used as an example of a Channel. You can find additional information on Channels here: https://www.ibm.com/support/knowledgecenter/en/SSFC4F_1.2.0/mcm/applications/managing_channels.html\n\n\n## Placement Rules\nPlacementRules are an MCM resource that define where resources should be deployed. PlacementRules by themeselves do not do anything, but can be included as a reference in other resource types or embedded in other MCM resource types.\n\nBelow is an example:\n\n```\nkubectl create -f - <<EOF\napiVersion: v1\nkind: Namespace\nmetadata: \n  name: etcd-project\n---\napiVersion: app.ibm.com/v1alpha1\nkind: PlacementRule\nmetadata:\n  name: my-placementrule\n  namespace: etcd-project\n  generation: 1\n  labels:\n    purpose: myapp\nspec:\n  clusterReplicas: 1\n  clusterLabels:\n    matchLabels:\n      cluster: myapp\nEOF\n```\n\nThe example PlacementRule is defining a rule called `my-placementrule` and will deploy the only on clusters that match the label `myapp`. This is a simple example, but PlacementRules can be used to determine number of replicas and more complex logic can be applied to control where MCM resources will be deployed.\n\nMore information on PlacementRules can be found here: https://www.ibm.com/support/knowledgecenter/en/SSFC4F_1.2.0/mcm/applications/managing_placement_rules.html\n\n\n## Subscriptions\nThe Subscription resource is the resource that combines the `Channel` and the `PlacementRule` to determine which resources should be deployed and where they should be deployed. A subscription does this by referencing a specific Deployable resource defined by a Channel and will either embed a PlacementRule or reference an existing PlacementRule. The Subscription can also modify the defualt values that maybe defined in a Deployable by defining `overrides`.\n\nExample Subscription:\n\n```\nkubectl create -f - <<EOF\napiVersion: app.ibm.com/v1alpha1\nkind: Subscription\nmetadata:\n  name: etcd\n  namespace: etcd-project\n  labels:\n    purpose: myapp\nspec:\n  channel: google-deployables/google-incubator-repo\n  name: etcd\n  packageFilter:\n    version: 0.7.3\n  placement:\n    placementRef:\n      name: my-placementrule\n      kind: PlacementRule\n      group: app.ibm.com\n  overrides:\n    - clusterName: \"/\"\n      clusterOverrides:\n      - path: \"metadata.namespace\"\n        value: myapp\nEOF\n```\nIn the example above we are creating a namespace called `etc-subscription` and we are creating a Subscription in that namespace called `etcd`. The subscription references the etcd version 0.7.3 Helm chart in the google-incbuator Channel created earier and references the PlacementRule `my-placementrule`. At the end of the subscription an override is defined to deploy the Helm chart in the namespace `myapp` instead of the default namespace.\n\nNote: The PlacementRule must be in the same namespace as the Subscription.\n\nAfter this is Subsciption is applied we can view our Subscription.\n```\noc get deployables.app.ibm.com -A | grep Subscription | grep etcd\netcd-project           etcd-deployable                                                    Subscription    app.ibm.com/v1alpha1   3m59s   Propagated\n```\n\nNotice that this shows that we created a Subscription and the status shows `Propagated`. This shows us that we have successfully created the Subscription, but there are no clusters that meet the criteria as targets for out PlacementRule.\n\nFirst let's get our available clusters\n```\noc get clusters -A\nNAMESPACE   NAME      MANAGED BY   ENDPOINTS                           STATUS   AGE\nctcp4ai     ctcp4ai   hub0         api.ctcp4ai.ocp.csplab.local:6443   Ready    15h\n```\n\nNext let's add the `myapp` label to the `ctcp4ai` cluster.\n\n```\noc label cluster ctcp4ai -n ctcp4ai cluster=myapp\n```\n\nNow let's check our Subscription again \n```\noc get deployables.app.ibm.com -A | grep Subscription | grep etcd\nctcp4ai                etcd-deployable-fh798                                              Subscription    app.ibm.com/v1alpha1   3m58s   Deployed\netcd-project           etcd-deployable                                                    Subscription    app.ibm.com/v1alpha1   3m59s   Propagated\n```\n\nNow we see that there is an additional Subscription in the namespace of the target cluster that shows `Deployed`. The HelmChart should now be deployed on the target cluster.\n\n#### From the target system\n\nOnce the Subsciption shows `Deployed` on the MCM Hub server you should be able to see the subscription on the target cluster:\n```\noc get subscriptions.app.ibm.com --all-namespaces | grep etcd\nmyapp       etcd                    Subscribed   11m\n```\n\nIn addition since this is a Helm chart subscription you should see a `helmrelease` object as well:\n```\noc get helmreleases.app.ibm.com --all-namespaces | grep etcd\nmyapp       etcd-etcd-myapp                           14m\n```\n\n\nFinally we can see that the Helm chart was deployed to the `myapp` namespace.\n```\noc get po -n myapp\nNAME      READY     STATUS    RESTARTS   AGE\netcd-0    1/1       Running   0          8m17s\netcd-1    1/1       Running   0          7m59s\netcd-2    1/1       Running   0          7m42s\n```\n\nAdditional documentation can be found to describe the Subscription resource here: https://www.ibm.com/support/knowledgecenter/en/SSFC4F_1.2.0/mcm/applications/managing_subscriptions.html\n\n\n## Applications\n\nThe Application resource is used to reference other MCM resources that we want to define as an Application. Since an Application may be composed of multiple MCM resources we can use selectors to compine the different components.\n\nIf you login to the MCM Console and Navigate to Manage Applications you will not see our etcd subscription. Even though we have already deployed the components we will not be able to manage them as a whole until we create an Application resource.\n\nSee the example below:\n\n```\nkubectl create -f - <<EOF\napiVersion: app.k8s.io/v1beta1\nkind: Application\nmetadata:\n  name: etcd-application\n  namespace: etcd-project\nspec:\n  selector:\n    matchLabels:\n      purpose: myapp\n  componentKinds:\n  - group: app.ibm.com\n    kind: Subscription\nEOF\n```\n\nMCM channel documentation\n\nhttps://www.ibm.com/support/knowledgecenter/en/SSFC4F_1.2.0/mcm/applications/managing_channels.html\n","type":"Mdx","contentDigest":"8fb20db02061ed5389dd7c0b8de1b77f","counter":215,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"MCM - Concepts","weight":310},"exports":{},"rawBody":"---\ntitle: MCM - Concepts\nweight: 310\n---\n- \n{:toc}\n\n\n## Overview\n\nMCM Manages applications by defining them as custom resource definitions in Kubernetes. By defining these resources we can install, delete and update resources on the managed MCM clusters. When these MCM resources are created the changes are applied on the target MCM cluster via the MCM Klusterlet.\n\nIn the next sections we will explore the different resources MCM provides.\n\n## Channels\n\nThe channel resource defines the location of an resource to be deployed. These resources can be a Helm repository, Kubernetes namespace, Object store or Git repository.\n\nThe sample below describes a Channel the points to a HelmRepo.\n\n```\nkubectl create -f - <<EOF\napiVersion: v1\nkind: Namespace\nmetadata: \n  name: google-deployables\n---\napiVersion: app.ibm.com/v1alpha1\nkind: Channel\nmetadata:\n  name: google-incubator-repo\n  namespace: google-deployables\nspec:\n    type: HelmRepo\n    pathname: http://storage.googleapis.com/kubernetes-charts-incubator\nEOF\n```\n\nOnce the channel definition above has been applied you can get your channel.\n\n```\noc get channels -n google-deployables\nNAME                    TYPE       PATHNAME                                                    AGE\ngoogle-incubator-repo   HelmRepo   http://storage.googleapis.com/kubernetes-charts-incubator   3m41s\n```\n\nWhen the channel is created it will query the target HelmRepo and create MCM `deployables` for each of the Helm charts in the repo.\n\n```\noc get deployables -n google-deployables\nNAME                                                               TEMPLATE-KIND   TEMPLATE-APIVERSION    AGE     STATUS\ngoogle-incubator-repo-artifactory-5.2.1                            HelmRelease     app.ibm.com/v1alpha1   5m39s\ngoogle-incubator-repo-aws-alb-ingress-controller-0.1.12            HelmRelease     app.ibm.com/v1alpha1   5m38s\ngoogle-incubator-repo-azuremonitor-containers-2.5.0                HelmRelease     app.ibm.com/v1alpha1   5m43s\n...\n...\n...\napp.ibm.com/v1alpha1   5m43s\ngoogle-incubator-repo-tensorflow-inception-0.4.1                   HelmRelease     app.ibm.com/v1alpha1   5m45s\ngoogle-incubator-repo-vault-0.23.4                                 HelmRelease     app.ibm.com/v1alpha1   5m50s\ngoogle-incubator-repo-vaultingkube-0.1.2                           HelmRelease     app.ibm.com/v1alpha1   5m50s\ngoogle-incubator-repo-webpagetest-agent-0.2.0                      HelmRelease     app.ibm.com/v1alpha1   5m50s\ngoogle-incubator-repo-webpagetest-server-0.2.1                     HelmRelease     app.ibm.com/v1alpha1   5m38s\ngoogle-incubator-repo-xray-0.3.2                                   HelmRelease     app.ibm.com/v1alpha1   5m49s\n```\n\nYou can see that all the Helm charts are now available as `deployables` and are available to be deployed using MCM. In this section a HelmRepo has been used as an example of a Channel. You can find additional information on Channels here: https://www.ibm.com/support/knowledgecenter/en/SSFC4F_1.2.0/mcm/applications/managing_channels.html\n\n\n## Placement Rules\nPlacementRules are an MCM resource that define where resources should be deployed. PlacementRules by themeselves do not do anything, but can be included as a reference in other resource types or embedded in other MCM resource types.\n\nBelow is an example:\n\n```\nkubectl create -f - <<EOF\napiVersion: v1\nkind: Namespace\nmetadata: \n  name: etcd-project\n---\napiVersion: app.ibm.com/v1alpha1\nkind: PlacementRule\nmetadata:\n  name: my-placementrule\n  namespace: etcd-project\n  generation: 1\n  labels:\n    purpose: myapp\nspec:\n  clusterReplicas: 1\n  clusterLabels:\n    matchLabels:\n      cluster: myapp\nEOF\n```\n\nThe example PlacementRule is defining a rule called `my-placementrule` and will deploy the only on clusters that match the label `myapp`. This is a simple example, but PlacementRules can be used to determine number of replicas and more complex logic can be applied to control where MCM resources will be deployed.\n\nMore information on PlacementRules can be found here: https://www.ibm.com/support/knowledgecenter/en/SSFC4F_1.2.0/mcm/applications/managing_placement_rules.html\n\n\n## Subscriptions\nThe Subscription resource is the resource that combines the `Channel` and the `PlacementRule` to determine which resources should be deployed and where they should be deployed. A subscription does this by referencing a specific Deployable resource defined by a Channel and will either embed a PlacementRule or reference an existing PlacementRule. The Subscription can also modify the defualt values that maybe defined in a Deployable by defining `overrides`.\n\nExample Subscription:\n\n```\nkubectl create -f - <<EOF\napiVersion: app.ibm.com/v1alpha1\nkind: Subscription\nmetadata:\n  name: etcd\n  namespace: etcd-project\n  labels:\n    purpose: myapp\nspec:\n  channel: google-deployables/google-incubator-repo\n  name: etcd\n  packageFilter:\n    version: 0.7.3\n  placement:\n    placementRef:\n      name: my-placementrule\n      kind: PlacementRule\n      group: app.ibm.com\n  overrides:\n    - clusterName: \"/\"\n      clusterOverrides:\n      - path: \"metadata.namespace\"\n        value: myapp\nEOF\n```\nIn the example above we are creating a namespace called `etc-subscription` and we are creating a Subscription in that namespace called `etcd`. The subscription references the etcd version 0.7.3 Helm chart in the google-incbuator Channel created earier and references the PlacementRule `my-placementrule`. At the end of the subscription an override is defined to deploy the Helm chart in the namespace `myapp` instead of the default namespace.\n\nNote: The PlacementRule must be in the same namespace as the Subscription.\n\nAfter this is Subsciption is applied we can view our Subscription.\n```\noc get deployables.app.ibm.com -A | grep Subscription | grep etcd\netcd-project           etcd-deployable                                                    Subscription    app.ibm.com/v1alpha1   3m59s   Propagated\n```\n\nNotice that this shows that we created a Subscription and the status shows `Propagated`. This shows us that we have successfully created the Subscription, but there are no clusters that meet the criteria as targets for out PlacementRule.\n\nFirst let's get our available clusters\n```\noc get clusters -A\nNAMESPACE   NAME      MANAGED BY   ENDPOINTS                           STATUS   AGE\nctcp4ai     ctcp4ai   hub0         api.ctcp4ai.ocp.csplab.local:6443   Ready    15h\n```\n\nNext let's add the `myapp` label to the `ctcp4ai` cluster.\n\n```\noc label cluster ctcp4ai -n ctcp4ai cluster=myapp\n```\n\nNow let's check our Subscription again \n```\noc get deployables.app.ibm.com -A | grep Subscription | grep etcd\nctcp4ai                etcd-deployable-fh798                                              Subscription    app.ibm.com/v1alpha1   3m58s   Deployed\netcd-project           etcd-deployable                                                    Subscription    app.ibm.com/v1alpha1   3m59s   Propagated\n```\n\nNow we see that there is an additional Subscription in the namespace of the target cluster that shows `Deployed`. The HelmChart should now be deployed on the target cluster.\n\n#### From the target system\n\nOnce the Subsciption shows `Deployed` on the MCM Hub server you should be able to see the subscription on the target cluster:\n```\noc get subscriptions.app.ibm.com --all-namespaces | grep etcd\nmyapp       etcd                    Subscribed   11m\n```\n\nIn addition since this is a Helm chart subscription you should see a `helmrelease` object as well:\n```\noc get helmreleases.app.ibm.com --all-namespaces | grep etcd\nmyapp       etcd-etcd-myapp                           14m\n```\n\n\nFinally we can see that the Helm chart was deployed to the `myapp` namespace.\n```\noc get po -n myapp\nNAME      READY     STATUS    RESTARTS   AGE\netcd-0    1/1       Running   0          8m17s\netcd-1    1/1       Running   0          7m59s\netcd-2    1/1       Running   0          7m42s\n```\n\nAdditional documentation can be found to describe the Subscription resource here: https://www.ibm.com/support/knowledgecenter/en/SSFC4F_1.2.0/mcm/applications/managing_subscriptions.html\n\n\n## Applications\n\nThe Application resource is used to reference other MCM resources that we want to define as an Application. Since an Application may be composed of multiple MCM resources we can use selectors to compine the different components.\n\nIf you login to the MCM Console and Navigate to Manage Applications you will not see our etcd subscription. Even though we have already deployed the components we will not be able to manage them as a whole until we create an Application resource.\n\nSee the example below:\n\n```\nkubectl create -f - <<EOF\napiVersion: app.k8s.io/v1beta1\nkind: Application\nmetadata:\n  name: etcd-application\n  namespace: etcd-project\nspec:\n  selector:\n    matchLabels:\n      purpose: myapp\n  componentKinds:\n  - group: app.ibm.com\n    kind: Subscription\nEOF\n```\n\nMCM channel documentation\n\nhttps://www.ibm.com/support/knowledgecenter/en/SSFC4F_1.2.0/mcm/applications/managing_channels.html\n","fileAbsolutePath":"/Users/davethiessen/github/cloudpak8s/src/pages/mcm/cp4mcm_mcm_concepts/index.mdx"}}}}