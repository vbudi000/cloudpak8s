{"componentChunkName":"component---src-pages-day-2-event-management-snmp-trap-index-mdx","path":"/day2/EventManagement/SNMP_Trap/","result":{"pageContext":{"frontmatter":{"title":"OpenShift Platform Day2 - Alert Manager to SNMP","description":"OpenShift Day2 Upgrade","keywords":"OpenShift, day2, supplement, alertmanager, snmp"},"relativePagePath":"/day2/EventManagement/SNMP_Trap/index.mdx","titleType":"page","MdxNode":{"id":"ed4bf1c0-287c-5f36-8030-dd3693d19cdf","children":[],"parent":"4e48c639-6513-5b43-9f46-f9cffcfc66ce","internal":{"content":"---\ntitle: OpenShift Platform Day2 - Alert Manager to SNMP\ndescription: OpenShift Day2 Upgrade\nkeywords: 'OpenShift, day2, supplement, alertmanager, snmp'\n---\n\n## Alert Manager to SNMP\n\n\nPrometheus Alertmanager natively supports a couple of different event destinations like Slack, email, PagerDuty, HipChat and [others](https://prometheus.io/docs/alerting/configuration/). For notification mechanisms not natively supported by the Alertmanager, the [webhook receiver](https://prometheus.io/docs/alerting/configuration/#webhook_config) allows for integration.\n\nSNMP traps are still a popular method of sending events informing about issues that needs to be reported.\nThe instructions below allows to quickly setup a simple integration mechanism which will allow to generate SNMP traps for selected Prometheus alerts using open source [Prometheus WebHook to SNMP-trap forwarder](https://github.com/chrusty/prometheus_webhook_snmptrapper).\n\n1). Copy `prometheus_webhook_snmptrapper` to a Linux server accessible from your Prometheus AlertManager instance (lets name it `linux1`). It is a single binary file which can be compiled from Golang [sources](https://github.com/chrusty/prometheus_webhook_snmptrapper) available on GitHub. You can also download the compiled Linux 64-bit version from [here](https://ibm.box.com/s/sn45d6n2mviwwi3iusmzpxa8fzd75l2p).\n\n2). Install `net-snmp` and `snmptrapd` packages. On Ubuntu run:\n\n```\nsudo apt-get install net-snmp snmptrapd\n```\n3). In the AlertManager configuration file, define the webhook receiver address in section `receivers`:\n\n```\n    receivers:\n      - name: prometheus_webhook_snmptrapper\n        webhook_configs:\n        - url: 'http://<linux1_ip>:9999'\n```\nPort `9999` is port of `prometheus_webhook_snmptrapper` webhook server (make sure if it not already taken by other process) and can be changed using input parameter of `prometheus_webhook_snmptrapper`. \n\nEdit Alertmanager secret in order to configure grouping and notification receiver.\n```\noc -n openshift-monitoring get secret alertmanager-main --template='{{ index .data \"alertmanager.yaml\" }}' |base64 -d > alertmanager.yaml\n```\nThen edit the `alertmanager.yaml`:\n```\nglobal:\n  resolve_timeout: 5m\nroute:\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 12h\n  receiver: default\n  routes:\n  - match:\n      service: example-app\n    routes:\n    - match:\n        severity: critical\n      receiver: prometheus_webhook_snmptrapper\nreceivers:\n  - name: prometheus_webhook_snmptrapper\n    webhook_configs:\n    - url: 'http://<linux1_ip>:9999'\n```\nWith this configuration, alerts of critical severity fired by the `example-app` service are sent using the `prometheus_webhook_snmptrapper` receiver, which means that these alerts are paged to a chosen person.\n\n```\n$ oc -n openshift-monitoring create secret generic alertmanager-main --from-file=alertmanager.yaml --dry-run -o=yaml |  oc -n openshift-monitoring replace secret --filename=-\n```\n\n\n4). Copy the following MIB files: [PROMETHEUS-TRAPPER-MIB.txt](https://raw.githubusercontent.com/chrusty/prometheus_webhook_snmptrapper/master/PROMETHEUS-TRAPPER-MIB.txt) and [SNMPv2-SNI](https://raw.githubusercontent.com/hardaker/net-snmp/master/mibs/SNMPv2-SMI.txt) to your MIB directory ex. `/usr/share/snmp/mibs`. You can find you MIBDIR using the following command:\n\n```\nsnmptranslate -Dinit_mib .1.3 2>&1 |grep MIBDIR\n```\n\n5). Start `snmptrapd` using:\n\n```\nsnmptrapd -n -Ls d -m PROMETHEUS-TRAPPER-MIB\n```\n\nIt will start snmptrapd as a daemon and SNMP traps will be logged to local syslog file (`/var/log/syslog` by default on Ubuntu).\n\n6). Start `prometheus_webhook_snmptrapper`\n\n```\n./prometheus_webhook_snmptrapper --webhookaddress 0.0.0.0:9999 > prom_snmp.log 2>&1  &\n```\n\n\n7). Verify that some Prometheus alerts has been generated after you started `prometheus_webhook_snmptrapper` and check the contents of syslog and `prom_snmp.log`.\n\nThe contents of `prom_snmp.log` should be similar to the one below:\n\n```\ntime=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Preparing the alerts channel\" logger=main\ntime=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Starting the SNMP trapper\" address=\"127.0.0.1:162\" logger=SNMP-trapper\ntime=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Starting the Webhook server\" address=\"0.0.0.0:9999\" logger=Webhook-server\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Received a valid webhook alert\" logger=Webhook-server payload=\"{\\\"receiver\\\":\\\"default-receiver\\\",\\\"status\\\":\\\"firing\\\",\\\"alerts\\\":[{\\\"status\\\":\\\"firing\\\",\\\"labels\\\":{\\\"alertname\\\":\\\"ICPMonitoringHeartbeat\\\",\\\"severity\\\":\\\"none\\\"},\\\"annotations\\\":{\\\"description\\\":\\\"This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.\\\",\\\"summary\\\":\\\"Alerting Heartbeat\\\"},\\\"startsAt\\\":\\\"2018-06-26T11:49:29.035689542Z\\\",\\\"endsAt\\\":\\\"0001-01-01T00:00:00Z\\\",\\\"generatorURL\\\":\\\"http://monitoring-prometheus-77d664c568-jzqnp:9090/graph?g0.expr=vector%281%29\\\\u0026g0.tab=1\\\"}],\\\"groupLabels\\\":{\\\"alertname\\\":\\\"ICPMonitoringHeartbeat\\\"},\\\"commonLabels\\\":{\\\"alertname\\\":\\\"ICPMonitoringHeartbeat\\\",\\\"severity\\\":\\\"none\\\"},\\\"commonAnnotations\\\":{\\\"description\\\":\\\"This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.\\\",\\\"summary\\\":\\\"Alerting Heartbeat\\\"},\\\"externalURL\\\":\\\"http://monitoring-prometheus-alertmanager-7fdbf6c5cd-xdlhh:9093\\\",\\\"version\\\":\\\"4\\\",\\\"groupKey\\\":\\\"{}/{alertname=\\\\\\\"ICPMonitoringHeartbeat\\\\\\\"}:{alertname=\\\\\\\"ICPMonitoringHeartbeat\\\\\\\"}\\\"}\\n\"\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Forwarding an alert to the SNMP trapper\" index=0 labels=\"map[alertname:ICPMonitoringHeartbeat severity:none]\" logger=Webhook-server status=firing\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Received an alert\" logger=SNMP-trapper status=firing\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Created snmpgo.SNMP object\" address=\"127.0.0.1:162\" community=public logger=SNMP-trapper retries=1\ntime=\"2018-07-05T09:51:05-05:00\" level=info msg=\"It's a trap!\" logger=SNMP-trapper status=firing\n```\n\nExample Prometheus SNMP traps logged to syslog:\n\n```\nAug  6 07:55:20 csmo-icp2103-rs snmptrapd[7453]: 2018-08-06 07:55:20 UDP: [127.0.0.1]:55091->[127.0.0.1]:162 [UDP: [127.0.0.1]:55091->[127.0.0.1]:162]:#012SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperFiringNotification#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationTimestamp = STRING: 2018-08-06T12:14:09Z#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationDescription = STRING: 99th percentile Latency for LIST requests to the kube-apiserver is higher than 1s.#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationInstance = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationSeverity = STRING: warning#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationLocation = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationService = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationJob = STRING: kubernetes-apiservers\nAug  6 07:57:30 csmo-icp2103-rs snmptrapd[7453]: 2018-08-06 07:57:30 UDP: [127.0.0.1]:39868->[127.0.0.1]:162 [UDP: [127.0.0.1]:39868->[127.0.0.1]:162]:#012SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperFiringNotification#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationTimestamp = STRING: 2018-08-06T12:00:29Z#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationDescription = STRING: This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationInstance = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationSeverity = STRING: none#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationLocation = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationService = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationJob = STRING:\n```","type":"Mdx","contentDigest":"a5a2ca4c5bcaa4098115e474abbf2591","counter":498,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"OpenShift Platform Day2 - Alert Manager to SNMP","description":"OpenShift Day2 Upgrade","keywords":"OpenShift, day2, supplement, alertmanager, snmp"},"exports":{},"rawBody":"---\ntitle: OpenShift Platform Day2 - Alert Manager to SNMP\ndescription: OpenShift Day2 Upgrade\nkeywords: 'OpenShift, day2, supplement, alertmanager, snmp'\n---\n\n## Alert Manager to SNMP\n\n\nPrometheus Alertmanager natively supports a couple of different event destinations like Slack, email, PagerDuty, HipChat and [others](https://prometheus.io/docs/alerting/configuration/). For notification mechanisms not natively supported by the Alertmanager, the [webhook receiver](https://prometheus.io/docs/alerting/configuration/#webhook_config) allows for integration.\n\nSNMP traps are still a popular method of sending events informing about issues that needs to be reported.\nThe instructions below allows to quickly setup a simple integration mechanism which will allow to generate SNMP traps for selected Prometheus alerts using open source [Prometheus WebHook to SNMP-trap forwarder](https://github.com/chrusty/prometheus_webhook_snmptrapper).\n\n1). Copy `prometheus_webhook_snmptrapper` to a Linux server accessible from your Prometheus AlertManager instance (lets name it `linux1`). It is a single binary file which can be compiled from Golang [sources](https://github.com/chrusty/prometheus_webhook_snmptrapper) available on GitHub. You can also download the compiled Linux 64-bit version from [here](https://ibm.box.com/s/sn45d6n2mviwwi3iusmzpxa8fzd75l2p).\n\n2). Install `net-snmp` and `snmptrapd` packages. On Ubuntu run:\n\n```\nsudo apt-get install net-snmp snmptrapd\n```\n3). In the AlertManager configuration file, define the webhook receiver address in section `receivers`:\n\n```\n    receivers:\n      - name: prometheus_webhook_snmptrapper\n        webhook_configs:\n        - url: 'http://<linux1_ip>:9999'\n```\nPort `9999` is port of `prometheus_webhook_snmptrapper` webhook server (make sure if it not already taken by other process) and can be changed using input parameter of `prometheus_webhook_snmptrapper`. \n\nEdit Alertmanager secret in order to configure grouping and notification receiver.\n```\noc -n openshift-monitoring get secret alertmanager-main --template='{{ index .data \"alertmanager.yaml\" }}' |base64 -d > alertmanager.yaml\n```\nThen edit the `alertmanager.yaml`:\n```\nglobal:\n  resolve_timeout: 5m\nroute:\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 12h\n  receiver: default\n  routes:\n  - match:\n      service: example-app\n    routes:\n    - match:\n        severity: critical\n      receiver: prometheus_webhook_snmptrapper\nreceivers:\n  - name: prometheus_webhook_snmptrapper\n    webhook_configs:\n    - url: 'http://<linux1_ip>:9999'\n```\nWith this configuration, alerts of critical severity fired by the `example-app` service are sent using the `prometheus_webhook_snmptrapper` receiver, which means that these alerts are paged to a chosen person.\n\n```\n$ oc -n openshift-monitoring create secret generic alertmanager-main --from-file=alertmanager.yaml --dry-run -o=yaml |  oc -n openshift-monitoring replace secret --filename=-\n```\n\n\n4). Copy the following MIB files: [PROMETHEUS-TRAPPER-MIB.txt](https://raw.githubusercontent.com/chrusty/prometheus_webhook_snmptrapper/master/PROMETHEUS-TRAPPER-MIB.txt) and [SNMPv2-SNI](https://raw.githubusercontent.com/hardaker/net-snmp/master/mibs/SNMPv2-SMI.txt) to your MIB directory ex. `/usr/share/snmp/mibs`. You can find you MIBDIR using the following command:\n\n```\nsnmptranslate -Dinit_mib .1.3 2>&1 |grep MIBDIR\n```\n\n5). Start `snmptrapd` using:\n\n```\nsnmptrapd -n -Ls d -m PROMETHEUS-TRAPPER-MIB\n```\n\nIt will start snmptrapd as a daemon and SNMP traps will be logged to local syslog file (`/var/log/syslog` by default on Ubuntu).\n\n6). Start `prometheus_webhook_snmptrapper`\n\n```\n./prometheus_webhook_snmptrapper --webhookaddress 0.0.0.0:9999 > prom_snmp.log 2>&1  &\n```\n\n\n7). Verify that some Prometheus alerts has been generated after you started `prometheus_webhook_snmptrapper` and check the contents of syslog and `prom_snmp.log`.\n\nThe contents of `prom_snmp.log` should be similar to the one below:\n\n```\ntime=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Preparing the alerts channel\" logger=main\ntime=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Starting the SNMP trapper\" address=\"127.0.0.1:162\" logger=SNMP-trapper\ntime=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Starting the Webhook server\" address=\"0.0.0.0:9999\" logger=Webhook-server\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Received a valid webhook alert\" logger=Webhook-server payload=\"{\\\"receiver\\\":\\\"default-receiver\\\",\\\"status\\\":\\\"firing\\\",\\\"alerts\\\":[{\\\"status\\\":\\\"firing\\\",\\\"labels\\\":{\\\"alertname\\\":\\\"ICPMonitoringHeartbeat\\\",\\\"severity\\\":\\\"none\\\"},\\\"annotations\\\":{\\\"description\\\":\\\"This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.\\\",\\\"summary\\\":\\\"Alerting Heartbeat\\\"},\\\"startsAt\\\":\\\"2018-06-26T11:49:29.035689542Z\\\",\\\"endsAt\\\":\\\"0001-01-01T00:00:00Z\\\",\\\"generatorURL\\\":\\\"http://monitoring-prometheus-77d664c568-jzqnp:9090/graph?g0.expr=vector%281%29\\\\u0026g0.tab=1\\\"}],\\\"groupLabels\\\":{\\\"alertname\\\":\\\"ICPMonitoringHeartbeat\\\"},\\\"commonLabels\\\":{\\\"alertname\\\":\\\"ICPMonitoringHeartbeat\\\",\\\"severity\\\":\\\"none\\\"},\\\"commonAnnotations\\\":{\\\"description\\\":\\\"This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.\\\",\\\"summary\\\":\\\"Alerting Heartbeat\\\"},\\\"externalURL\\\":\\\"http://monitoring-prometheus-alertmanager-7fdbf6c5cd-xdlhh:9093\\\",\\\"version\\\":\\\"4\\\",\\\"groupKey\\\":\\\"{}/{alertname=\\\\\\\"ICPMonitoringHeartbeat\\\\\\\"}:{alertname=\\\\\\\"ICPMonitoringHeartbeat\\\\\\\"}\\\"}\\n\"\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Forwarding an alert to the SNMP trapper\" index=0 labels=\"map[alertname:ICPMonitoringHeartbeat severity:none]\" logger=Webhook-server status=firing\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Received an alert\" logger=SNMP-trapper status=firing\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Created snmpgo.SNMP object\" address=\"127.0.0.1:162\" community=public logger=SNMP-trapper retries=1\ntime=\"2018-07-05T09:51:05-05:00\" level=info msg=\"It's a trap!\" logger=SNMP-trapper status=firing\n```\n\nExample Prometheus SNMP traps logged to syslog:\n\n```\nAug  6 07:55:20 csmo-icp2103-rs snmptrapd[7453]: 2018-08-06 07:55:20 UDP: [127.0.0.1]:55091->[127.0.0.1]:162 [UDP: [127.0.0.1]:55091->[127.0.0.1]:162]:#012SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperFiringNotification#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationTimestamp = STRING: 2018-08-06T12:14:09Z#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationDescription = STRING: 99th percentile Latency for LIST requests to the kube-apiserver is higher than 1s.#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationInstance = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationSeverity = STRING: warning#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationLocation = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationService = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationJob = STRING: kubernetes-apiservers\nAug  6 07:57:30 csmo-icp2103-rs snmptrapd[7453]: 2018-08-06 07:57:30 UDP: [127.0.0.1]:39868->[127.0.0.1]:162 [UDP: [127.0.0.1]:39868->[127.0.0.1]:162]:#012SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperFiringNotification#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationTimestamp = STRING: 2018-08-06T12:00:29Z#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationDescription = STRING: This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationInstance = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationSeverity = STRING: none#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationLocation = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationService = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationJob = STRING:\n```","fileAbsolutePath":"/home/travis/build/ibm-cloud-architecture/cloudpak8s/src/pages/day2/EventManagement/SNMP_Trap/index.mdx"}}}}