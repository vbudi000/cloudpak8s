{"componentChunkName":"component---src-pages-mcm-cp-4-mcm-nom-day-2-asm-day-2-v-center-index-mdx","path":"/mcm/cp4mcm_nom_day2/asm_day2_vCenter/","result":{"pageContext":{"frontmatter":{"title":"MCM - ASM - Day2 - Troubleshooting vCenter REST Observer","description":"Day 2 articles on Operating Netcool Ops Manager","keywords":"day2, asm, nom, netcool_ops_manager"},"relativePagePath":"/mcm/cp4mcm_nom_day2/asm_day2_vCenter/index.mdx","titleType":"page","MdxNode":{"id":"60d27a8c-7c7b-5518-9285-4ddf1b4fb0da","children":[],"parent":"e6999cb2-dde3-58f8-8547-f690e889e4d8","internal":{"content":"---\ntitle: MCM - ASM - Day2 - Troubleshooting vCenter REST Observer\ndescription: Day 2 articles on Operating Netcool Ops Manager\nkeywords: 'day2, asm, nom, netcool_ops_manager'\n---\n\n[Back to NOM Day2](/mcm/cp4mcm_nom_day2)\n\n\n## Troubleshooting Agile Service Manager vCenter Observer.\nASM (Agile Service Manager) provides _Out of the Box_ integration to the managed system through its **Observer**.  One such Observer is the vCenter Observer.  The following describes an example of troubleshooting the vCenter Observer by interacting with the vCenter REST interface.\n\n\n## The issue.\nASM vCenter Observer \"talk\" to VMWare vCenter REST interface to get the information it needs. VCenter version 6.5 is one of the supported versions by ASM. \nOne problem with working with the REST interface based Observer is that you might not see an immediate error as you run the Observer, but nothing is displayed in ASM.\nThe following is the process of troubleshooting the Observer.\n\n## The scenario.\nWe configure the ASM vCenter Observer and provide the relevant information, including the vCenter username and password in the ASM UI.  We run the Observer through the User Interface.  It ran to completion without error.  We try to see the topology, and no vCenter topology is displayed.\n\n## The tool.\nYou can use many tools to talk to a REST interface; some tools provide a nice Graphical User Interface. This article uses **CURL**, as it is widely available in a Linux platform.  \n\n## The troubleshooting Steps.\n\n### Check the log files.\nChecking the observer log files gives the following warning message:\n\n```\nWARN   [2019-06-19 00:39:15,344] [cfd95b7e-3bc7-4006-a4a8-a73a79c71255:LAB-vCenter/VCenterHostTask] c.i.i.t.o.v.j.r.t.VCenterHostTask -  Could not obtain Host Info data via REST\n```\n\nThe observer job exited after encountering those WARNING, which explained why there is no vCenter information in ASM.  \n\n\n### Ensure that the REST interface is available.\nFirst, you need to ensure that the vCenter responded to a REST API call; you can start by querying the base address.\nVCenter REST can normally be accessed via https://[hostname or ipaddress]/rest.\n\n```\n$ curl -sik -H 'Accept:application/json' -X GET https://[vcenter-address]/rest\n```\n\nThe flag:\n    -s (for silent), is to exclude progress meter.  This is useful for concise output.\n    -i this is to include the HTTP response headers in the output. As you will see later, the response header can help in debugging.\n    -k (or --insecure) allows curl to accept a self-signed SSL server connection.\n    -H (or --header) for specifying the header of the query. We want a JSON formatted output.\n    -X (or --request) this is where you specify your request.\n    \nThe server responded with the following:\n\n```\nHTTP/1.1 200 OK\nDate: Wed, 19 Jun 2019 00:56:24 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\n{\n  \"value\": {\n    \"components\": {\n      \"metadata\": {\n        \"method\": \"GET\",\n        \"href\": \"https://[vCenter Address]/rest/com/vmware/vapi/metadata/metamodel/service/operation/id:com.vmware.vapi.rest.navigation.component/id:list\"\n      },\n      \"method\": \"GET\",\n      \"href\": \"https://[vCenter Address]/rest/com/vmware/vapi/rest/navigation/component\"\n    },\n    \"resources\": {\n      \"metadata\": {\n        \"method\": \"GET\",\n        \"href\": \"https://[vCenter Address]/rest/com/vmware/vapi/metadata/metamodel/service/operation/id:com.vmware.vapi.rest.navigation.resource/id:list\"\n      },\n      \"method\": \"GET\",\n      \"href\": \"https://[vCenter Address]/rest/com/vmware/vapi/rest/navigation/resource\"\n    }\n  }\n}\n```\n\nWith this, we know that the Server's REST Interface is working fine.\n\n### The endpoint\nAs we are troubleshooting an ASM discovery, we needed to know the endpoint that ASM was querying.  One way to do this is to force an error by specifying a wrong username and password, to get the following message in the log file.\n\n```\nERROR  [2019-06-19 00:36:31,005] [cfd95b7e-3bc7-4006-a4a8-a73a79c71255:CSPLAB-vCenter/VCenterHostTask] c.i.i.t.o.v.j.r.t.VCenterHostTask -  Could not gain access to VMware VCenter endpoint 'https://[vcenter address]/rest/vcenter/host' - check your keyStore path in job parameter. Reason:- An VMware VCenter session-id Token could not be obtained, check if the credential are correct.Cannot deserialize instance of `java.lang.String` out of START_OBJECT token\n```\n\nJust what we wanted.  The endpoint was: `https://[vcenter-address]/rest/vcenter/host`.  Checking the VMWare REST documentation and verified that indeed this was a valid endpoint.\n\n### Verify without Authorization.\nWe need to specify some user information for  Authentication/Authorization before we can query more detail.  To verify, let us try without any user information first.\n\n```\n$ curl -sik -H 'Accept:application/json' -X GET https://[vcenter-address]/rest/vcenter/host\n\nHTTP/1.1 401 Unauthorized\nDate: Wed, 19 Jun 2019 01:05:00 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\n{\n  \"type\": \"com.vmware.vapi.std.errors.unauthenticated\",\n  \"value\": {\n    \"messages\": [\n      {\n        \"args\": [],\n        \"default_message\": \"This method requires authentication.\",\n        \"id\": \"vapi.method.authentication.required\"\n      }\n    ]\n  }\n}\n\n```\n\nAs expected, we received _\"This method requires authentication.\"_ response.  Note the header. It said the same thing: `401 - Unauthorized`. As mentioned earlier, the header can be useful.\n\n### Get the session ID.\nFor vCenter, the authorization is a two steps process. First, you specify your username and password to get a Session-ID, then use the Session-ID in the query.\n\n```\n$ curl -X POST --insecure --header 'Content-Type: application/json' --header 'Accept: application/json' --header 'vmware-use-header-authn: test' --header 'vmware-api-session-id: null' -u 'username:password' 'https://[vcenter-address]/rest/com/vmware/cis/session'\n```\n\nThe server responded with the session-ID:\n```\n{\"value\":\"d2de956a5f0e072aa546e91fcf70f3dc\"}\n```\n\n### Use the Session ID\nWe run the same query as in step 3, but this time, we added the session-ID.\n\n```\n$ curl -sik -H 'Accept:application/json' -H \"vmware-api-session-id:d2de956a5f0e072aa546e91fcf70f3dc\" -X GET https://[vcenter-address]/rest/vcenter/host\n```\n\nAnd we may get the following response.\n\n```\nHTTP/1.1 500 Server Error\nDate: Wed, 19 Jun 2019 00:51:24 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\n{\n  \"type\": \"com.vmware.vapi.std.errors.internal_server_error\",\n  \"value\": {\n    \"messages\": [\n      {\n        \"args\": [\n          \"com.vmware.vapi.std.errors.Unauthorized\"\n        ],\n        \"default_message\": \"Provider method implementation threw unexpected exception: com.vmware.vapi.std.errors.Unauthorized\",\n        \"id\": \"vapi.bindings.method.impl.unexpected\"\n      },\n      {\n        \"args\": [],\n        \"default_message\": \"Not authorized to perform this operation.\",\n        \"id\": \"com.vmware.api.vcenter.unauthorized\"\n      }\n    ]\n  }\n}\n```\n\nAha! We just found out about the issue! The Session-ID and hence the username and password did not have enough privilege to run the query.\n\nNote that, unlike the response that we got in step 3, we now have a server error response header, and the message was also different.  \n\n### An authorized user, please.\nWith the above information, we can go back to the vCenter admin. Asked for a proper credential, and rerun the query with the the authorized user, and here is the query and the response, a good and valid response:\n\n```\n$curl -sik -H 'Accept:application/json' -H \"vmware-api-session-id:292a717da90093ccfb46ec66e8789e65\" -X GET https://[vcenter-address]/rest/vcenter/host\nHTTP/1.1 200 OK\nDate: Wed, 19 Jun 2019 01:52:51 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\n{\n  \"value\": [\n    {\n      \"host\": \"host-151\",\n      \"name\": \"172.16.3.133\",\n      \"connection_state\": \"CONNECTED\",\n      \"power_state\": \"POWERED_ON\"\n    },\n    . . . - cut for brevity - . . .\n    {\n      \"host\": \"host-89\",\n      \"name\": \"172.16.3.124\",\n      \"connection_state\": \"CONNECTED\",\n      \"power_state\": \"POWERED_ON\"\n    }\n  ]\n}\n```\n\n### Let there be an ASM topology.\nWe know now that my manual query works. We can go back to ASM, rerun the vCenter Observer job, lo and behold, and display the topology.\n\n![vCenter Topology](./images/asm_vcenter_topo.png \"vCenter Topology\")\n\n[Back to NOM Day2](/mcm/cp4mcm_nom_day2)","type":"Mdx","contentDigest":"a5887f5cb3f434798cd619f8dfa2713a","counter":538,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"MCM - ASM - Day2 - Troubleshooting vCenter REST Observer","description":"Day 2 articles on Operating Netcool Ops Manager","keywords":"day2, asm, nom, netcool_ops_manager"},"exports":{},"rawBody":"---\ntitle: MCM - ASM - Day2 - Troubleshooting vCenter REST Observer\ndescription: Day 2 articles on Operating Netcool Ops Manager\nkeywords: 'day2, asm, nom, netcool_ops_manager'\n---\n\n[Back to NOM Day2](/mcm/cp4mcm_nom_day2)\n\n\n## Troubleshooting Agile Service Manager vCenter Observer.\nASM (Agile Service Manager) provides _Out of the Box_ integration to the managed system through its **Observer**.  One such Observer is the vCenter Observer.  The following describes an example of troubleshooting the vCenter Observer by interacting with the vCenter REST interface.\n\n\n## The issue.\nASM vCenter Observer \"talk\" to VMWare vCenter REST interface to get the information it needs. VCenter version 6.5 is one of the supported versions by ASM. \nOne problem with working with the REST interface based Observer is that you might not see an immediate error as you run the Observer, but nothing is displayed in ASM.\nThe following is the process of troubleshooting the Observer.\n\n## The scenario.\nWe configure the ASM vCenter Observer and provide the relevant information, including the vCenter username and password in the ASM UI.  We run the Observer through the User Interface.  It ran to completion without error.  We try to see the topology, and no vCenter topology is displayed.\n\n## The tool.\nYou can use many tools to talk to a REST interface; some tools provide a nice Graphical User Interface. This article uses **CURL**, as it is widely available in a Linux platform.  \n\n## The troubleshooting Steps.\n\n### Check the log files.\nChecking the observer log files gives the following warning message:\n\n```\nWARN   [2019-06-19 00:39:15,344] [cfd95b7e-3bc7-4006-a4a8-a73a79c71255:LAB-vCenter/VCenterHostTask] c.i.i.t.o.v.j.r.t.VCenterHostTask -  Could not obtain Host Info data via REST\n```\n\nThe observer job exited after encountering those WARNING, which explained why there is no vCenter information in ASM.  \n\n\n### Ensure that the REST interface is available.\nFirst, you need to ensure that the vCenter responded to a REST API call; you can start by querying the base address.\nVCenter REST can normally be accessed via https://[hostname or ipaddress]/rest.\n\n```\n$ curl -sik -H 'Accept:application/json' -X GET https://[vcenter-address]/rest\n```\n\nThe flag:\n    -s (for silent), is to exclude progress meter.  This is useful for concise output.\n    -i this is to include the HTTP response headers in the output. As you will see later, the response header can help in debugging.\n    -k (or --insecure) allows curl to accept a self-signed SSL server connection.\n    -H (or --header) for specifying the header of the query. We want a JSON formatted output.\n    -X (or --request) this is where you specify your request.\n    \nThe server responded with the following:\n\n```\nHTTP/1.1 200 OK\nDate: Wed, 19 Jun 2019 00:56:24 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\n{\n  \"value\": {\n    \"components\": {\n      \"metadata\": {\n        \"method\": \"GET\",\n        \"href\": \"https://[vCenter Address]/rest/com/vmware/vapi/metadata/metamodel/service/operation/id:com.vmware.vapi.rest.navigation.component/id:list\"\n      },\n      \"method\": \"GET\",\n      \"href\": \"https://[vCenter Address]/rest/com/vmware/vapi/rest/navigation/component\"\n    },\n    \"resources\": {\n      \"metadata\": {\n        \"method\": \"GET\",\n        \"href\": \"https://[vCenter Address]/rest/com/vmware/vapi/metadata/metamodel/service/operation/id:com.vmware.vapi.rest.navigation.resource/id:list\"\n      },\n      \"method\": \"GET\",\n      \"href\": \"https://[vCenter Address]/rest/com/vmware/vapi/rest/navigation/resource\"\n    }\n  }\n}\n```\n\nWith this, we know that the Server's REST Interface is working fine.\n\n### The endpoint\nAs we are troubleshooting an ASM discovery, we needed to know the endpoint that ASM was querying.  One way to do this is to force an error by specifying a wrong username and password, to get the following message in the log file.\n\n```\nERROR  [2019-06-19 00:36:31,005] [cfd95b7e-3bc7-4006-a4a8-a73a79c71255:CSPLAB-vCenter/VCenterHostTask] c.i.i.t.o.v.j.r.t.VCenterHostTask -  Could not gain access to VMware VCenter endpoint 'https://[vcenter address]/rest/vcenter/host' - check your keyStore path in job parameter. Reason:- An VMware VCenter session-id Token could not be obtained, check if the credential are correct.Cannot deserialize instance of `java.lang.String` out of START_OBJECT token\n```\n\nJust what we wanted.  The endpoint was: `https://[vcenter-address]/rest/vcenter/host`.  Checking the VMWare REST documentation and verified that indeed this was a valid endpoint.\n\n### Verify without Authorization.\nWe need to specify some user information for  Authentication/Authorization before we can query more detail.  To verify, let us try without any user information first.\n\n```\n$ curl -sik -H 'Accept:application/json' -X GET https://[vcenter-address]/rest/vcenter/host\n\nHTTP/1.1 401 Unauthorized\nDate: Wed, 19 Jun 2019 01:05:00 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\n{\n  \"type\": \"com.vmware.vapi.std.errors.unauthenticated\",\n  \"value\": {\n    \"messages\": [\n      {\n        \"args\": [],\n        \"default_message\": \"This method requires authentication.\",\n        \"id\": \"vapi.method.authentication.required\"\n      }\n    ]\n  }\n}\n\n```\n\nAs expected, we received _\"This method requires authentication.\"_ response.  Note the header. It said the same thing: `401 - Unauthorized`. As mentioned earlier, the header can be useful.\n\n### Get the session ID.\nFor vCenter, the authorization is a two steps process. First, you specify your username and password to get a Session-ID, then use the Session-ID in the query.\n\n```\n$ curl -X POST --insecure --header 'Content-Type: application/json' --header 'Accept: application/json' --header 'vmware-use-header-authn: test' --header 'vmware-api-session-id: null' -u 'username:password' 'https://[vcenter-address]/rest/com/vmware/cis/session'\n```\n\nThe server responded with the session-ID:\n```\n{\"value\":\"d2de956a5f0e072aa546e91fcf70f3dc\"}\n```\n\n### Use the Session ID\nWe run the same query as in step 3, but this time, we added the session-ID.\n\n```\n$ curl -sik -H 'Accept:application/json' -H \"vmware-api-session-id:d2de956a5f0e072aa546e91fcf70f3dc\" -X GET https://[vcenter-address]/rest/vcenter/host\n```\n\nAnd we may get the following response.\n\n```\nHTTP/1.1 500 Server Error\nDate: Wed, 19 Jun 2019 00:51:24 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\n{\n  \"type\": \"com.vmware.vapi.std.errors.internal_server_error\",\n  \"value\": {\n    \"messages\": [\n      {\n        \"args\": [\n          \"com.vmware.vapi.std.errors.Unauthorized\"\n        ],\n        \"default_message\": \"Provider method implementation threw unexpected exception: com.vmware.vapi.std.errors.Unauthorized\",\n        \"id\": \"vapi.bindings.method.impl.unexpected\"\n      },\n      {\n        \"args\": [],\n        \"default_message\": \"Not authorized to perform this operation.\",\n        \"id\": \"com.vmware.api.vcenter.unauthorized\"\n      }\n    ]\n  }\n}\n```\n\nAha! We just found out about the issue! The Session-ID and hence the username and password did not have enough privilege to run the query.\n\nNote that, unlike the response that we got in step 3, we now have a server error response header, and the message was also different.  \n\n### An authorized user, please.\nWith the above information, we can go back to the vCenter admin. Asked for a proper credential, and rerun the query with the the authorized user, and here is the query and the response, a good and valid response:\n\n```\n$curl -sik -H 'Accept:application/json' -H \"vmware-api-session-id:292a717da90093ccfb46ec66e8789e65\" -X GET https://[vcenter-address]/rest/vcenter/host\nHTTP/1.1 200 OK\nDate: Wed, 19 Jun 2019 01:52:51 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\n{\n  \"value\": [\n    {\n      \"host\": \"host-151\",\n      \"name\": \"172.16.3.133\",\n      \"connection_state\": \"CONNECTED\",\n      \"power_state\": \"POWERED_ON\"\n    },\n    . . . - cut for brevity - . . .\n    {\n      \"host\": \"host-89\",\n      \"name\": \"172.16.3.124\",\n      \"connection_state\": \"CONNECTED\",\n      \"power_state\": \"POWERED_ON\"\n    }\n  ]\n}\n```\n\n### Let there be an ASM topology.\nWe know now that my manual query works. We can go back to ASM, rerun the vCenter Observer job, lo and behold, and display the topology.\n\n![vCenter Topology](./images/asm_vcenter_topo.png \"vCenter Topology\")\n\n[Back to NOM Day2](/mcm/cp4mcm_nom_day2)","fileAbsolutePath":"/home/travis/build/ibm-cloud-architecture/cloudpak8s/src/pages/mcm/cp4mcm_nom_day2/asm_day2_vCenter/index.mdx"}}}}