{"componentChunkName":"component---src-pages-integration-cp-4-i-deploy-api-mgmt-2020-1-x-index-mdx","path":"/integration/cp4i-deploy-api-mgmt-2020.1.x/","result":{"pageContext":{"frontmatter":{"title":"API Management","description":"Basic guide for deploying API Connect (APIC)","keywords":"ibm, install, integration, API, API Connect"},"relativePagePath":"/integration/cp4i-deploy-api-mgmt-2020.1.x/index.mdx","titleType":"page","MdxNode":{"id":"29b1cbea-0f72-5914-a76d-5747dc7e2375","children":[],"parent":"60dfc1ec-d885-5b5c-9528-68a8bf409091","internal":{"content":"---\ntitle: API Management\ndescription: Basic guide for deploying API Connect (APIC)\nkeywords: 'ibm, install, integration, API, API Connect'\n---\n\n<InlineNotification>\n\nVersion 2020.2 is out for Cloud Pak for Ingegration.  This version is the first to feature Operators and has significant changes to the deployment and operations.  Please refer to the [Knowledge Center](https://www.ibm.com/support/knowledgecenter/en/SSGT7J_20.2/overview.html) while we update this playbook.  Thanks!\n\n</InlineNotification>\n\nThis page contains guidance on how to configure the API Connect (APIC)\nrelease for both on-prem and IBM Cloud.\n\n<AnchorLinks>\n  <AnchorLink>Prepare endpoints</AnchorLink>\n  <AnchorLink>Obtain the pull secret</AnchorLink>\n  <AnchorLink>Create the TLS secret</AnchorLink>\n  <AnchorLink>Increase vm.max_map_count</AnchorLink>\n  <AnchorLink>Storage class</AnchorLink>\n  <AnchorLink>Create an instance</AnchorLink>\n  <AnchorLink>Configure APIC to work with Tracing</AnchorLink>\n  <AnchorLink>SMTP server</AnchorLink>\n  <AnchorLink>Configuring the API Connect</AnchorLink>\n</AnchorLinks>\n\n### **Prepare endpoints**\n\nWe have to define the endpoint for each of the APIC subsystems. We can\n\"construct\" the endpoints by adding descriptive \"prefixes\" to the proxy\nURL. In the sample described here, the proxy URL was\n`icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud`\nso we defined the endpoints as follows:\n\nParameter | Sample Value\n-- | --\nAPI Manager UI endpoint | mgmt.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nCloud Admin UI endpoint | mcadmin.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nPlatform API endpoint | mpapi.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nConsumer API endpoint | mcapi.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nAPI Gateway | gw.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nGateway Service | gwd.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nAnalytics Client | ac.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nAnalytics Ingestion | ai.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nPortal | portal.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nPortal Director | padmin.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n\n### **Obtain the pull secret**\n\nFor online installs (where your cluster has connectivity to internet), you can pull the product images directly from\nthe IBM Container Software Library aka the Entitled Container Registry. \nFor this, you will need to create a kubernetes secret which contains the \nthe value of your IBM Entitlement Key. Instructions for doing this are in the CP4I product documentation under \nthe topic [API management capability deployment](https://www.ibm.com/support/knowledgecenter/en/SSGT7J_20.1/install/install_api.html).\nSearch for the heading \"imagePullSecret\".\n\nFor Offline or \"air gap\" installs, you will be pulling the images from your cluster's internal registry. In this case,\nyou can use one of the pull secrets that's already configured in your target namespace (`apic` by default). Login to the OCP CLI and run:\n```\noc get secrets -n <target-namespace>\n```\nThe pull secret starts with **deployer-dockercfg**. In our case it was:\n```\ndeployer-dockercfg-7mlqd\n```\n\n### **Create the TLS secret**\n\nThe easiest way to accomplish this is to create the TLS Secret using the Visual Web Terminal inside of the Cloud Pak Foundation window.  To access this window do the following\n\n1. Via the Platform Navigator. Select the Hamburger menu, top left and\nthen select **Cloud Pak Foundation**\n\n   ![](/assets/img/integration/deploy-api-mgmt/8.common-cli.png)\n2. Select the Visual Web Terminal icon.  2nd Icon from the right\n(looks like the box)\n\n   ![](/assets/img/integration/deploy-api-mgmt/9.cli2.png)\n3. The Visual Web Terminal will start and then once it connects to your\ncluster you can enter in commands.  Try to enter a command\nlike `helm ls`.  You should see output like the following:\n\n   ![](/assets/img/integration/deploy-api-mgmt/10.visual.png)\n4. Now you can run the following command to create the TLS secret:\n   ```\n   oc create secret generic apic-ent-helm-tls --from-file=cert.pem=$HOME/.helm/cert.pem --from-file=ca.pem=$HOME/.helm/ca.pem --from-file=key.pem=$HOME/.helm/key.pem -n apic\n   ```\n   where **apic-ent-helm-tls** is the name of the secret.\n\n### **Increase vm.max_map_count**\n\nTo check and increase `vm.max_map_count` we would need an *ssh* access to each of the cluster nodes.\n\nThe alternative is to create a DaemonSet which will do that for us. Prepare the yaml file with the following content:\n```yaml\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  labels:\n    k8s-app: sysctl-conf\n  name: sysctl-conf\n  namespace: kube-system\nspec:\n  template:\n    metadata:\n      labels:\n        k8s-app: sysctl-conf\n    spec:\n      containers:\n      - command:\n        - sh\n        - -c\n        - sysctl -w vm.max_map_count=1048575 && while true; do sleep 86400; done\n        image: busybox:1.26.2\n        name: sysctl-conf\n        resources:\n          limits:\n            cpu: 10m\n            memory: 50Mi\n          requests:\n            cpu: 10m\n            memory: 50Mi\n        securityContext:\n          privileged: true\n      terminationGracePeriodSeconds: 1\n```\n\nand run apply it with:\n\n```\noc apply -f sysctl-conf.yaml\n```\n*Note* if you have done something similar for eventstreams, note that\nthe required value of vm.max_map_count is higher than what was\nrequired\n\n### **Storage class**\n\nThe **block storage class** is needed for APIC.\nYou can obtain the class names with\n```\noc get storageclass\n```\n\nThe follwing classes are available on IBM Cloud:\n```\nNAME                          PROVISIONER         AGE\ndefault                       ibm.io/ibmc-file    9d\nibmc-block-bronze (default)   ibm.io/ibmc-block   9d\nibmc-block-custom             ibm.io/ibmc-block   9d\nibmc-block-gold               ibm.io/ibmc-block   9d\nibmc-block-retain-bronze      ibm.io/ibmc-block   9d\nibmc-block-retain-custom      ibm.io/ibmc-block   9d\nibmc-block-retain-gold        ibm.io/ibmc-block   9d\nibmc-block-retain-silver      ibm.io/ibmc-block   9d\nibmc-block-silver             ibm.io/ibmc-block   9d\nibmc-file-bronze              ibm.io/ibmc-file    9d\nibmc-file-custom              ibm.io/ibmc-file    9d\nibmc-file-gold                ibm.io/ibmc-file    9d\nibmc-file-retain-bronze       ibm.io/ibmc-file    9d\nibmc-file-retain-custom       ibm.io/ibmc-file    9d\nibmc-file-retain-gold         ibm.io/ibmc-file    9d\nibmc-file-retain-silver       ibm.io/ibmc-file    9d\nibmc-file-silver              ibm.io/ibmc-file    9d\n```\n\nIn our case, we decided to use `ibmc-block-gold`.  This will work with IBM Cloud based installs.  Offline Installs Require Ceph.  Other Clouds like AWS have their own block storage.  Be sure to check their documentation.\n\n\n### **Prepare a target namespace for your APIC instance**\n\nEach instance of APIC must be deployed into a dedicated namespace. When CP4I is first installed, the `apic` namespace is created and pre-configured for this purpose. If you are deploying into the pre-configured `apic` namespace, you can proceed to instructions for creating your instance.\n\nIf you are not installing into the pre-configured `apic` namespace, you need to issue the following `oc adm` commands to grant some needed permissions on the target namespace. The notation `<target-namespace>` in the instructions that follow, refer to the namespace into which you are deploying your APIC instance. \n\n```\noc project <target-namespace>\noc adm policy add-scc-to-group ibm-anyuid-hostpath-scc system:serviceaccounts:<target-namespace>\n```\n\nThis command sequence grants any service account that is running in your target namespace, with the\n`ibm-anyuid-hostid-scc` security context permissions.\n\n### **Create an instance**\n\n- Open platform navigator and select **API Connect** / **Create instance**\n\n- Click *Continue*\n- Define the helm release name, select **apic** namespace and the local-cluster.\n\n- Enter the registry secret name, helm TLS secret name and select storage class:\n\n- Enter the management and portal endpoints:\n![Platform endpoints](/assets/img/integration/apic-roks/Snip20190909_16.png)\n\n- Scroll enter the analytics and gateway endpoints:\n![Gateway endpoints](/assets/img/integration/apic-roks/Snip20190909_17.png)\n\n- If not already, switch the view to show all parameters\n![All params](/assets/img/integration/apic-roks/Snip20190909_17c.png)\n\n- For the non-production installation, you may switch the mode to **dev**\n![Mode](/assets/img/integration/apic-roks/Snip20190909_17d.png)\n\n- and the number of gateway replicas to **1**\n![Replicas](/assets/img/integration/apic-roks/Snip20190909_17b.png)\n\n- Make sure the checkbox for `v5 Gateway Compatibility` is *not* checked (i.e. disabled), otherwise od tracing will not function.  See [here](https://www.ibm.com/support/knowledgecenter/SSGT7J_19.4/install/od_register.html)\nfor more information.  Only APIs using the API Gateway (not the v5 Compatible Gateway) will deliver data to the Operations Dashboard)\n\n- Ensure the `Enable OD Tracing` check box is enabled (i.e. checked).  Ensure the proper tracing namespace is populated in the requisite box.\n\n- Click on **Install**, the confirmation message will appear:\n![Install](/assets/img/integration/apic-roks/Snip20190909_19.png)\n\n- You can check the status of the pods with the command:\n```\noc get pods -n apic\n```\n- When deployment is completed, all pods must be in **Running** or **Completed** state.  This entire process could take over an hour to complete.  The list of pods should look similar to this one:\n```\napic-ibm-apiconnect-icp4i-prod-operator-0 1/1 Running 1 2h\nr09aaff73f9-analytics-proxy-5c95c649d9-2ld22 1/1 Running 0 2h\nr09aaff73f9-apiconnect-cc-0 1/1 Running 0 4h\nr09aaff73f9-apiconnect-cc-1 1/1 Running 0 3h\nr09aaff73f9-apiconnect-cc-2 1/1 Running 0 2h\nr09aaff73f9-apiconnect-cc-repair-1582765200-b5964 0/1 Completed 0 2h\nr09aaff73f9-apim-v2-857cd65d49-2mpsc 1/1 Running 0 2h\nr09aaff73f9-client-dl-srv-5c74686597-j5rmw 1/1 Running 0 2h\nr09aaff73f9-juhu-b995789c-c7glf 1/1 Running 0 2h\nr09aaff73f9-ldap-6656df9f7-cfv49 1/1 Running 0 2h\nr09aaff73f9-lur-v2-5ddddcfc77-r2k74 1/1 Running 0 2h\nr09aaff73f9-ui-6dbcf69d48-qhwtk 1/1 Running 0 2h\nr307b84ffe1-analytics-client-5758786cf8-k484c 1/1 Running 0 2h\nr307b84ffe1-analytics-cronjobs-retention-1582767000-dnmvk 0/1 Completed 0 1h\nr307b84ffe1-analytics-cronjobs-rollover-1582771500-gzh7w 0/1 Completed 0 15m\nr307b84ffe1-analytics-ingestion-6d9dd9c977-5rhx2 1/1 Running 0 2h\nr307b84ffe1-analytics-mtls-gw-7c9fbbbfcd-pmdzq 1/1 Running 0 2h\nr307b84ffe1-analytics-operator-785bf8c8c9-n6nxs 1/1 Running 0 2h\nr307b84ffe1-analytics-storage-coordinating-5d596f596b-hd7v4 1/1 Running 0 2h\nr307b84ffe1-analytics-storage-data-0 1/1 Running 0 2h\nr307b84ffe1-analytics-storage-master-0 1/1 Running 0 3h\nr9a3cf2a2d0-cassandra-operator-54c75c5c6f-mvfd2 1/1 Running 0 2h\nrbcb357bd8b-apic-portal-db-0 2/2 Running 0 4h\nrbcb357bd8b-apic-portal-nginx-6d5b5f9d5c-bbczb 1/1 Running 0 2h\nrbcb357bd8b-apic-portal-www-0 2/2 Running 0 4h\nrf9ad2183d2-datapower-monitor-5c4cb7d895-zjxc2 1/1 Running 0 2h\nrf9ad2183d2-dynamic-gateway-service-0 3/3 Running 0 3h\n```\n### **Configure APIC to work with Tracing**\n\n1. Near the end of the install of APIC, a job will be created that has the\nname `odtracing.registration`.  This job will not complete until the\nRegistration is completed inside of the Tracing capability.\n2. What will happen is that a request will be created inside of tracing\nthat you need to act upon.  Navigate to the Platform Navigator and via the\nHamburger menu select Tracing and then when the window pops out select\nthe name of your tracing instance which should be called `tracing`\n![](/assets/img/integration/deploy-api-mgmt/13.tracing-nav.png)\n3. Within tracing, select the `Manage` icon from the menu.  Looks like a\ncog wheel.\n![](/assets/img/integration/deploy-api-mgmt/14.tracing-from-menu.png)\n4. Click on the `Registration Requests` icon.\n5. You should see a new registration request for your APIC install.  Click\nthe `approve` link\n6. You will see a pop up window with some lines to copy to your clipboard.\nClick the 2 boxes icon in the top right icon to copy the commands required.\n![](/assets/img/integration/deploy-api-mgmt/15.process-request.png)\n7. Ensuring you have an active `oc` session and in the `apic` project.\nPaste the commands to the window and it will run then and finish the\nprocessing.\n8. If you are slow in doing the steps above.  It is possible you might see\nthe `odtracing.registration` job fail.  No worries.  Once you complete the\npasting of the commands to create your secret, the job will re-create\nitself.\n\n\n\n### **SMTP server**\n\nIn order to configure the API Connect, we need a SMTP server.\n\nA quick and easy setup for an smtp server required by API Connect is to use MailTrap.io. Go to https://mailtrap.io and set yourself an account. I believe you are limited to 500 emails per month for free. See pricing plans at https://mailtrap.io/pricing. Once you reach the monthly limit, you'll get the SMTP protocol error: \"535 5.7.\n\nSome key info you need in order to setup the smtp resource in the APIC Cloud are smtp server address. port number, username, and password.\n\nOnce setup with MailTrap.io, clink on your inbox link in MailTrap and copy the username and password from the credentials section into the APIC username and password fields.\n\nYou will see something similar below in the credentials section in MailTrap:\n\nconfig.action_mailer.smtp_settings = {\n:user_name => 'xxxxxxxxxxxxx',\n:password => 'xxxxxxxxxxxxxx',\n:address => 'smtp.mailtrap.io',\n:domain => 'smtp.mailtrap.io',\n:port => '2525',\n:authentication => :cram_md5address: smtp.mailtrap.io\n\naddress and port can also be take directly from the credentials section.\n\naddress: smtp.mailtrap.io\nport: 2525\nusername: xxxxxxxxxxxxx\npassword: xxxxxxxxxxxx\n\nClick the Test button in the APIC Cloud Manager and your email will be successfully sent and you can view it in MailTrap.io\n\n\n### **Configuring the API Connect**\n\n- You can access your new install by starting from the Platform Navigator\n\n- Select IBM Cloud Private user, default username and password in this case are admin/admin\n![Login CMC](/assets/img/integration/apic-roks/Snip20190910_32.png)\n\n- Under **Resources/Notifications** define the SMTP server\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_51.png)\n\n- For our Mailtrap server enter ClusterIP address and port:\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_53.png)\n\n- Under **Settings/Notifications** edit the sender email server:\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_56.png)\n\n- And select the SMTP server defined under resources:\n![email](/assets/img/integration/apic-roks/Snip20190910_57.png)\n\n- Start with the **Topology** configuration\n![Topology](/assets/img/integration/apic-roks/Snip20190910_34.png)\n\n- Register service:\n![Register Service](/assets/img/integration/apic-roks/Snip20190910_35.png)\n\n- Start with the Gateway, select the version that you defined under the Helm release properties when you started creating the instance.\n\n- ![Gateway](/assets/img/integration/apic-roks/Snip20190910_36.png)\n\n- Give some name to the service (e.g. **gateway1**) enter the **endpoints** and click on **Save**:\n![Gateway](/assets/img/integration/apic-roks/Snip20190910_38.png)\n\n- The confirmation message should appear:\n![Gateway](/assets/img/integration/apic-roks/Snip20190910_40.png)\n\n- Click on *Register service* again and select Analytics:\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_43.png)\n\n- Give some name to the service, enter Management endpoint (the one that you defined for **analytics client**) and click **Save**\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_44.png)\n\n- The confirmation appears:\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_46.png)\n\n- Before configuring the portal, you must make sure the admin_email is defined.  This done by clicking the User icon in the Cloud Manager, then go to `My Account`.  Fill out the details in the Profile window that comes up.  The email field is mandatory, the remaining are optional.  Click `Save` when complete.\n![Portal](/assets/img/integration/apic-roks/Snip20190910_48.png)\n\n- Repeat the same with portal:\n![Portal](/assets/img/integration/apic-roks/Snip20190910_48.png)\n\n- The confirmation appears again:\n![Portal](/assets/img/integration/apic-roks/Snip20190910_62.png)\n\n- Click on **Associate Analytics Service** to associate analytics with the gateway:\n![Associate analytics](/assets/img/integration/apic-roks/Snip20190910_63.png)\n\n- Select the analytics service:\n![Associate analytics](/assets/img/integration/apic-roks/Snip20190910_64.png)\n\n- Click on **Provider organizations** and add new organization:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_66.png)\n\n- Give some name to the organization:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_67.png)\n\n- Define the owner\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_68.png)\n\n- After you submit the organization will appear on the list:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_69.png)\n\n- Navigate to the API Manager, in our case the endpoint was:\n`https://mgmt.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud/manage`\n\n- Login as the owner (defined in the previous step), the API Manager page should open:\n![API Mgr](/assets/img/integration/apic-roks/Snip20190910_70.png)\n\n- You can navigate to the catalog:\n![Sandbox](/assets/img/integration/apic-roks/Snip20190910_71.png)\n\n- and create portal\n![Create portal](/assets/img/integration/apic-roks/Snip20190910_73.png)\n\n- You can also assign the gateway to the catalog\n![Catalog](/assets/img/integration/apic-roks/Snip20190910_79.png)\n\nWith that, your API Connect instance is ready for usage.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n---\n","type":"Mdx","contentDigest":"f3a4f21c0153d12fa33dae6d161cec6a","counter":549,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"API Management","description":"Basic guide for deploying API Connect (APIC)","keywords":"ibm, install, integration, API, API Connect"},"exports":{},"rawBody":"---\ntitle: API Management\ndescription: Basic guide for deploying API Connect (APIC)\nkeywords: 'ibm, install, integration, API, API Connect'\n---\n\n<InlineNotification>\n\nVersion 2020.2 is out for Cloud Pak for Ingegration.  This version is the first to feature Operators and has significant changes to the deployment and operations.  Please refer to the [Knowledge Center](https://www.ibm.com/support/knowledgecenter/en/SSGT7J_20.2/overview.html) while we update this playbook.  Thanks!\n\n</InlineNotification>\n\nThis page contains guidance on how to configure the API Connect (APIC)\nrelease for both on-prem and IBM Cloud.\n\n<AnchorLinks>\n  <AnchorLink>Prepare endpoints</AnchorLink>\n  <AnchorLink>Obtain the pull secret</AnchorLink>\n  <AnchorLink>Create the TLS secret</AnchorLink>\n  <AnchorLink>Increase vm.max_map_count</AnchorLink>\n  <AnchorLink>Storage class</AnchorLink>\n  <AnchorLink>Create an instance</AnchorLink>\n  <AnchorLink>Configure APIC to work with Tracing</AnchorLink>\n  <AnchorLink>SMTP server</AnchorLink>\n  <AnchorLink>Configuring the API Connect</AnchorLink>\n</AnchorLinks>\n\n### **Prepare endpoints**\n\nWe have to define the endpoint for each of the APIC subsystems. We can\n\"construct\" the endpoints by adding descriptive \"prefixes\" to the proxy\nURL. In the sample described here, the proxy URL was\n`icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud`\nso we defined the endpoints as follows:\n\nParameter | Sample Value\n-- | --\nAPI Manager UI endpoint | mgmt.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nCloud Admin UI endpoint | mcadmin.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nPlatform API endpoint | mpapi.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nConsumer API endpoint | mcapi.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nAPI Gateway | gw.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nGateway Service | gwd.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nAnalytics Client | ac.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nAnalytics Ingestion | ai.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nPortal | portal.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\nPortal Director | padmin.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud\n\n### **Obtain the pull secret**\n\nFor online installs (where your cluster has connectivity to internet), you can pull the product images directly from\nthe IBM Container Software Library aka the Entitled Container Registry. \nFor this, you will need to create a kubernetes secret which contains the \nthe value of your IBM Entitlement Key. Instructions for doing this are in the CP4I product documentation under \nthe topic [API management capability deployment](https://www.ibm.com/support/knowledgecenter/en/SSGT7J_20.1/install/install_api.html).\nSearch for the heading \"imagePullSecret\".\n\nFor Offline or \"air gap\" installs, you will be pulling the images from your cluster's internal registry. In this case,\nyou can use one of the pull secrets that's already configured in your target namespace (`apic` by default). Login to the OCP CLI and run:\n```\noc get secrets -n <target-namespace>\n```\nThe pull secret starts with **deployer-dockercfg**. In our case it was:\n```\ndeployer-dockercfg-7mlqd\n```\n\n### **Create the TLS secret**\n\nThe easiest way to accomplish this is to create the TLS Secret using the Visual Web Terminal inside of the Cloud Pak Foundation window.  To access this window do the following\n\n1. Via the Platform Navigator. Select the Hamburger menu, top left and\nthen select **Cloud Pak Foundation**\n\n   ![](/assets/img/integration/deploy-api-mgmt/8.common-cli.png)\n2. Select the Visual Web Terminal icon.  2nd Icon from the right\n(looks like the box)\n\n   ![](/assets/img/integration/deploy-api-mgmt/9.cli2.png)\n3. The Visual Web Terminal will start and then once it connects to your\ncluster you can enter in commands.  Try to enter a command\nlike `helm ls`.  You should see output like the following:\n\n   ![](/assets/img/integration/deploy-api-mgmt/10.visual.png)\n4. Now you can run the following command to create the TLS secret:\n   ```\n   oc create secret generic apic-ent-helm-tls --from-file=cert.pem=$HOME/.helm/cert.pem --from-file=ca.pem=$HOME/.helm/ca.pem --from-file=key.pem=$HOME/.helm/key.pem -n apic\n   ```\n   where **apic-ent-helm-tls** is the name of the secret.\n\n### **Increase vm.max_map_count**\n\nTo check and increase `vm.max_map_count` we would need an *ssh* access to each of the cluster nodes.\n\nThe alternative is to create a DaemonSet which will do that for us. Prepare the yaml file with the following content:\n```yaml\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  labels:\n    k8s-app: sysctl-conf\n  name: sysctl-conf\n  namespace: kube-system\nspec:\n  template:\n    metadata:\n      labels:\n        k8s-app: sysctl-conf\n    spec:\n      containers:\n      - command:\n        - sh\n        - -c\n        - sysctl -w vm.max_map_count=1048575 && while true; do sleep 86400; done\n        image: busybox:1.26.2\n        name: sysctl-conf\n        resources:\n          limits:\n            cpu: 10m\n            memory: 50Mi\n          requests:\n            cpu: 10m\n            memory: 50Mi\n        securityContext:\n          privileged: true\n      terminationGracePeriodSeconds: 1\n```\n\nand run apply it with:\n\n```\noc apply -f sysctl-conf.yaml\n```\n*Note* if you have done something similar for eventstreams, note that\nthe required value of vm.max_map_count is higher than what was\nrequired\n\n### **Storage class**\n\nThe **block storage class** is needed for APIC.\nYou can obtain the class names with\n```\noc get storageclass\n```\n\nThe follwing classes are available on IBM Cloud:\n```\nNAME                          PROVISIONER         AGE\ndefault                       ibm.io/ibmc-file    9d\nibmc-block-bronze (default)   ibm.io/ibmc-block   9d\nibmc-block-custom             ibm.io/ibmc-block   9d\nibmc-block-gold               ibm.io/ibmc-block   9d\nibmc-block-retain-bronze      ibm.io/ibmc-block   9d\nibmc-block-retain-custom      ibm.io/ibmc-block   9d\nibmc-block-retain-gold        ibm.io/ibmc-block   9d\nibmc-block-retain-silver      ibm.io/ibmc-block   9d\nibmc-block-silver             ibm.io/ibmc-block   9d\nibmc-file-bronze              ibm.io/ibmc-file    9d\nibmc-file-custom              ibm.io/ibmc-file    9d\nibmc-file-gold                ibm.io/ibmc-file    9d\nibmc-file-retain-bronze       ibm.io/ibmc-file    9d\nibmc-file-retain-custom       ibm.io/ibmc-file    9d\nibmc-file-retain-gold         ibm.io/ibmc-file    9d\nibmc-file-retain-silver       ibm.io/ibmc-file    9d\nibmc-file-silver              ibm.io/ibmc-file    9d\n```\n\nIn our case, we decided to use `ibmc-block-gold`.  This will work with IBM Cloud based installs.  Offline Installs Require Ceph.  Other Clouds like AWS have their own block storage.  Be sure to check their documentation.\n\n\n### **Prepare a target namespace for your APIC instance**\n\nEach instance of APIC must be deployed into a dedicated namespace. When CP4I is first installed, the `apic` namespace is created and pre-configured for this purpose. If you are deploying into the pre-configured `apic` namespace, you can proceed to instructions for creating your instance.\n\nIf you are not installing into the pre-configured `apic` namespace, you need to issue the following `oc adm` commands to grant some needed permissions on the target namespace. The notation `<target-namespace>` in the instructions that follow, refer to the namespace into which you are deploying your APIC instance. \n\n```\noc project <target-namespace>\noc adm policy add-scc-to-group ibm-anyuid-hostpath-scc system:serviceaccounts:<target-namespace>\n```\n\nThis command sequence grants any service account that is running in your target namespace, with the\n`ibm-anyuid-hostid-scc` security context permissions.\n\n### **Create an instance**\n\n- Open platform navigator and select **API Connect** / **Create instance**\n\n- Click *Continue*\n- Define the helm release name, select **apic** namespace and the local-cluster.\n\n- Enter the registry secret name, helm TLS secret name and select storage class:\n\n- Enter the management and portal endpoints:\n![Platform endpoints](/assets/img/integration/apic-roks/Snip20190909_16.png)\n\n- Scroll enter the analytics and gateway endpoints:\n![Gateway endpoints](/assets/img/integration/apic-roks/Snip20190909_17.png)\n\n- If not already, switch the view to show all parameters\n![All params](/assets/img/integration/apic-roks/Snip20190909_17c.png)\n\n- For the non-production installation, you may switch the mode to **dev**\n![Mode](/assets/img/integration/apic-roks/Snip20190909_17d.png)\n\n- and the number of gateway replicas to **1**\n![Replicas](/assets/img/integration/apic-roks/Snip20190909_17b.png)\n\n- Make sure the checkbox for `v5 Gateway Compatibility` is *not* checked (i.e. disabled), otherwise od tracing will not function.  See [here](https://www.ibm.com/support/knowledgecenter/SSGT7J_19.4/install/od_register.html)\nfor more information.  Only APIs using the API Gateway (not the v5 Compatible Gateway) will deliver data to the Operations Dashboard)\n\n- Ensure the `Enable OD Tracing` check box is enabled (i.e. checked).  Ensure the proper tracing namespace is populated in the requisite box.\n\n- Click on **Install**, the confirmation message will appear:\n![Install](/assets/img/integration/apic-roks/Snip20190909_19.png)\n\n- You can check the status of the pods with the command:\n```\noc get pods -n apic\n```\n- When deployment is completed, all pods must be in **Running** or **Completed** state.  This entire process could take over an hour to complete.  The list of pods should look similar to this one:\n```\napic-ibm-apiconnect-icp4i-prod-operator-0 1/1 Running 1 2h\nr09aaff73f9-analytics-proxy-5c95c649d9-2ld22 1/1 Running 0 2h\nr09aaff73f9-apiconnect-cc-0 1/1 Running 0 4h\nr09aaff73f9-apiconnect-cc-1 1/1 Running 0 3h\nr09aaff73f9-apiconnect-cc-2 1/1 Running 0 2h\nr09aaff73f9-apiconnect-cc-repair-1582765200-b5964 0/1 Completed 0 2h\nr09aaff73f9-apim-v2-857cd65d49-2mpsc 1/1 Running 0 2h\nr09aaff73f9-client-dl-srv-5c74686597-j5rmw 1/1 Running 0 2h\nr09aaff73f9-juhu-b995789c-c7glf 1/1 Running 0 2h\nr09aaff73f9-ldap-6656df9f7-cfv49 1/1 Running 0 2h\nr09aaff73f9-lur-v2-5ddddcfc77-r2k74 1/1 Running 0 2h\nr09aaff73f9-ui-6dbcf69d48-qhwtk 1/1 Running 0 2h\nr307b84ffe1-analytics-client-5758786cf8-k484c 1/1 Running 0 2h\nr307b84ffe1-analytics-cronjobs-retention-1582767000-dnmvk 0/1 Completed 0 1h\nr307b84ffe1-analytics-cronjobs-rollover-1582771500-gzh7w 0/1 Completed 0 15m\nr307b84ffe1-analytics-ingestion-6d9dd9c977-5rhx2 1/1 Running 0 2h\nr307b84ffe1-analytics-mtls-gw-7c9fbbbfcd-pmdzq 1/1 Running 0 2h\nr307b84ffe1-analytics-operator-785bf8c8c9-n6nxs 1/1 Running 0 2h\nr307b84ffe1-analytics-storage-coordinating-5d596f596b-hd7v4 1/1 Running 0 2h\nr307b84ffe1-analytics-storage-data-0 1/1 Running 0 2h\nr307b84ffe1-analytics-storage-master-0 1/1 Running 0 3h\nr9a3cf2a2d0-cassandra-operator-54c75c5c6f-mvfd2 1/1 Running 0 2h\nrbcb357bd8b-apic-portal-db-0 2/2 Running 0 4h\nrbcb357bd8b-apic-portal-nginx-6d5b5f9d5c-bbczb 1/1 Running 0 2h\nrbcb357bd8b-apic-portal-www-0 2/2 Running 0 4h\nrf9ad2183d2-datapower-monitor-5c4cb7d895-zjxc2 1/1 Running 0 2h\nrf9ad2183d2-dynamic-gateway-service-0 3/3 Running 0 3h\n```\n### **Configure APIC to work with Tracing**\n\n1. Near the end of the install of APIC, a job will be created that has the\nname `odtracing.registration`.  This job will not complete until the\nRegistration is completed inside of the Tracing capability.\n2. What will happen is that a request will be created inside of tracing\nthat you need to act upon.  Navigate to the Platform Navigator and via the\nHamburger menu select Tracing and then when the window pops out select\nthe name of your tracing instance which should be called `tracing`\n![](/assets/img/integration/deploy-api-mgmt/13.tracing-nav.png)\n3. Within tracing, select the `Manage` icon from the menu.  Looks like a\ncog wheel.\n![](/assets/img/integration/deploy-api-mgmt/14.tracing-from-menu.png)\n4. Click on the `Registration Requests` icon.\n5. You should see a new registration request for your APIC install.  Click\nthe `approve` link\n6. You will see a pop up window with some lines to copy to your clipboard.\nClick the 2 boxes icon in the top right icon to copy the commands required.\n![](/assets/img/integration/deploy-api-mgmt/15.process-request.png)\n7. Ensuring you have an active `oc` session and in the `apic` project.\nPaste the commands to the window and it will run then and finish the\nprocessing.\n8. If you are slow in doing the steps above.  It is possible you might see\nthe `odtracing.registration` job fail.  No worries.  Once you complete the\npasting of the commands to create your secret, the job will re-create\nitself.\n\n\n\n### **SMTP server**\n\nIn order to configure the API Connect, we need a SMTP server.\n\nA quick and easy setup for an smtp server required by API Connect is to use MailTrap.io. Go to https://mailtrap.io and set yourself an account. I believe you are limited to 500 emails per month for free. See pricing plans at https://mailtrap.io/pricing. Once you reach the monthly limit, you'll get the SMTP protocol error: \"535 5.7.\n\nSome key info you need in order to setup the smtp resource in the APIC Cloud are smtp server address. port number, username, and password.\n\nOnce setup with MailTrap.io, clink on your inbox link in MailTrap and copy the username and password from the credentials section into the APIC username and password fields.\n\nYou will see something similar below in the credentials section in MailTrap:\n\nconfig.action_mailer.smtp_settings = {\n:user_name => 'xxxxxxxxxxxxx',\n:password => 'xxxxxxxxxxxxxx',\n:address => 'smtp.mailtrap.io',\n:domain => 'smtp.mailtrap.io',\n:port => '2525',\n:authentication => :cram_md5address: smtp.mailtrap.io\n\naddress and port can also be take directly from the credentials section.\n\naddress: smtp.mailtrap.io\nport: 2525\nusername: xxxxxxxxxxxxx\npassword: xxxxxxxxxxxx\n\nClick the Test button in the APIC Cloud Manager and your email will be successfully sent and you can view it in MailTrap.io\n\n\n### **Configuring the API Connect**\n\n- You can access your new install by starting from the Platform Navigator\n\n- Select IBM Cloud Private user, default username and password in this case are admin/admin\n![Login CMC](/assets/img/integration/apic-roks/Snip20190910_32.png)\n\n- Under **Resources/Notifications** define the SMTP server\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_51.png)\n\n- For our Mailtrap server enter ClusterIP address and port:\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_53.png)\n\n- Under **Settings/Notifications** edit the sender email server:\n![SMTP](/assets/img/integration/apic-roks/Snip20190910_56.png)\n\n- And select the SMTP server defined under resources:\n![email](/assets/img/integration/apic-roks/Snip20190910_57.png)\n\n- Start with the **Topology** configuration\n![Topology](/assets/img/integration/apic-roks/Snip20190910_34.png)\n\n- Register service:\n![Register Service](/assets/img/integration/apic-roks/Snip20190910_35.png)\n\n- Start with the Gateway, select the version that you defined under the Helm release properties when you started creating the instance.\n\n- ![Gateway](/assets/img/integration/apic-roks/Snip20190910_36.png)\n\n- Give some name to the service (e.g. **gateway1**) enter the **endpoints** and click on **Save**:\n![Gateway](/assets/img/integration/apic-roks/Snip20190910_38.png)\n\n- The confirmation message should appear:\n![Gateway](/assets/img/integration/apic-roks/Snip20190910_40.png)\n\n- Click on *Register service* again and select Analytics:\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_43.png)\n\n- Give some name to the service, enter Management endpoint (the one that you defined for **analytics client**) and click **Save**\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_44.png)\n\n- The confirmation appears:\n![Analytics](/assets/img/integration/apic-roks/Snip20190910_46.png)\n\n- Before configuring the portal, you must make sure the admin_email is defined.  This done by clicking the User icon in the Cloud Manager, then go to `My Account`.  Fill out the details in the Profile window that comes up.  The email field is mandatory, the remaining are optional.  Click `Save` when complete.\n![Portal](/assets/img/integration/apic-roks/Snip20190910_48.png)\n\n- Repeat the same with portal:\n![Portal](/assets/img/integration/apic-roks/Snip20190910_48.png)\n\n- The confirmation appears again:\n![Portal](/assets/img/integration/apic-roks/Snip20190910_62.png)\n\n- Click on **Associate Analytics Service** to associate analytics with the gateway:\n![Associate analytics](/assets/img/integration/apic-roks/Snip20190910_63.png)\n\n- Select the analytics service:\n![Associate analytics](/assets/img/integration/apic-roks/Snip20190910_64.png)\n\n- Click on **Provider organizations** and add new organization:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_66.png)\n\n- Give some name to the organization:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_67.png)\n\n- Define the owner\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_68.png)\n\n- After you submit the organization will appear on the list:\n![ProvOrg](/assets/img/integration/apic-roks/Snip20190910_69.png)\n\n- Navigate to the API Manager, in our case the endpoint was:\n`https://mgmt.icp-proxy.icp4i-6550a99fb8cff23207ccecc2183787a9-0001.us-east.containers.appdomain.cloud/manage`\n\n- Login as the owner (defined in the previous step), the API Manager page should open:\n![API Mgr](/assets/img/integration/apic-roks/Snip20190910_70.png)\n\n- You can navigate to the catalog:\n![Sandbox](/assets/img/integration/apic-roks/Snip20190910_71.png)\n\n- and create portal\n![Create portal](/assets/img/integration/apic-roks/Snip20190910_73.png)\n\n- You can also assign the gateway to the catalog\n![Catalog](/assets/img/integration/apic-roks/Snip20190910_79.png)\n\nWith that, your API Connect instance is ready for usage.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n---\n","fileAbsolutePath":"/home/travis/build/ibm-cloud-architecture/cloudpak8s/src/pages/integration/cp4i-deploy-api-mgmt-2020.1.x/index.mdx"}}}}